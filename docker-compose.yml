services:
  # ========== SERVICES ==========
  # Database: Local PostgreSQL (Docker Desktop'tan çalışıyor)
  # Host: host.docker.internal, DB: resell, User: postgres, Pass: postgres

  # Auth Service
  auth-service:
    build:
      context: ./services/auth
      dockerfile: Dockerfile.dev
    container_name: auth-service
    working_dir: /var/www/html
    entrypoint: ["/bin/sh", "/var/www/html/docker-entrypoint-dev.sh"]
    environment:
      APP_ENV: dev
      APP_SECRET: dev-secret-key-12345
      DATABASE_URL: postgresql://postgres:postgres@host.docker.internal:5432/resell?serverVersion=16&charset=utf8
      CORS_ALLOW_ORIGIN: "^https?://(localhost|127\\.0\\.0\\.1)(:[0-9]+)?$$"
    ports:
      - "8001:8000"
    volumes:
      - ./services/auth:/var/www/html
    networks:
      - microservices
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Listing Service
  listing-service:
    build:
      context: ./services/listing
      dockerfile: Dockerfile.dev
    container_name: listing-service
    working_dir: /var/www/listing
    entrypoint: ["/bin/sh", "/var/www/listing/docker-entrypoint-dev.sh"]
    environment:
      APP_ENV: dev
      APP_SECRET: dev-secret-key-12345
      DATABASE_URL: postgresql://postgres:postgres@host.docker.internal:5432/resell?serverVersion=16&charset=utf8
      CORS_ALLOW_ORIGIN: "^https?://(localhost|127\\.0\\.0\\.1)(:[0-9]+)?$$"
      ELASTICSEARCH_URL: http://elasticsearch:9200
    ports:
      - "8082:8000"
    volumes:
      - ./services/listing:/var/www/listing
    networks:
      - microservices
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - elasticsearch

  # Backend Monolith
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: backend
    working_dir: /app
    entrypoint: ["/bin/sh", "/app/docker-entrypoint-dev.sh"]
    environment:
      APP_ENV: dev
      APP_SECRET: dev-secret-key-12345
      DATABASE_URL: postgresql://postgres:postgres@host.docker.internal:5432/resell?serverVersion=16&charset=utf8
      CORS_ALLOW_ORIGIN: "^https?://(localhost|127\\.0\\.0\\.1)(:[0-9]+)?$$"
      FRONTEND_URL: http://localhost:3000
      # Cloudflare R2 Storage
      R2_ENDPOINT: https://56751b8361542d95b3c6aa19e5807694.r2.cloudflarestorage.com
      R2_REGION: auto
      R2_BUCKET: resell-uploads-dev
      R2_ACCESS_KEY_ID: ad8fbcac1bc20e2be3f659d0678078ab
      R2_SECRET_ACCESS_KEY: 054281a76b2b91d8ef736a332460b44932443b21b09c629019820141cff48c76
      R2_PUBLIC_BASE_URL: https://pub-f04ef83f9e1f46f2a18b4f27db086b8e.r2.dev
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    networks:
      - microservices
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Messaging Service
  messaging-service:
    build:
      context: ./services/messaging
      dockerfile: Dockerfile.dev
    container_name: messaging-service
    working_dir: /var/www/messaging
    entrypoint: ["/bin/bash", "/usr/local/bin/docker-entrypoint-dev.sh"]
    environment:
      APP_ENV: dev
      APP_SECRET: dev-secret-key-12345
      JWT_SECRET: dev-secret-key-12345
      DATABASE_URL: postgresql://postgres:postgres@messaging-db:5432/messaging?serverVersion=16&charset=utf8
      CORS_ALLOW_ORIGIN: "^https?://(localhost|127\\.0\\.0\\.1)(:[0-9]+)?$$"
      AUTH_SERVICE_URL: http://auth-service:8000
      LISTING_SERVICE_URL: http://listing-service:8000
      # Pusher (optional - leave empty to disable realtime)
      PUSHER_APP_ID: ""
      PUSHER_KEY: ""
      PUSHER_SECRET: ""
      PUSHER_CLUSTER: "eu"
    ports:
      - "8083:8000"
    volumes:
      - ./services/messaging:/var/www/messaging
    networks:
      - microservices
    depends_on:
      - messaging-db
      - auth-service
      - listing-service

  # Frontend
  frontend:
    image: node:20-alpine
    container_name: frontend
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 3000"
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    networks:
      - microservices
    environment:
      VITE_API_URL: http://localhost:8000
      VITE_AUTH_SERVICE_URL: http://localhost:8001
      VITE_LISTING_SERVICE_URL: http://localhost:8082
      VITE_MESSAGING_SERVICE_URL: http://localhost:8083
      # Pusher (optional - leave empty to disable realtime)
      VITE_PUSHER_KEY: ""
      VITE_PUSHER_CLUSTER: "eu"

  # ========== INFRASTRUCTURE ==========
  
  # Messaging Database
  messaging-db:
    image: postgres:16-alpine
    container_name: messaging-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: messaging
    ports:
      - "5433:5432"
    volumes:
      - messaging_db_data:/var/lib/postgresql/data
    networks:
      - microservices
  
  # Elasticsearch
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.3
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - microservices
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200 >/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Kibana (debug için - opsiyonel)
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.3
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    networks:
      - microservices
    depends_on:
      - elasticsearch

volumes:
  frontend_node_modules:
  elasticsearch_data:
  messaging_db_data:

networks:
  microservices:
    driver: bridge
